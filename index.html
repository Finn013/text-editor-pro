<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Текстовый редактор Pro</title>
  <meta name="description" content="Современный текстовый редактор с поддержкой вкладок, форматирования и мобильных устройств">
  <meta name="theme-color" content="#6366f1">
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    /* CSS Variables for theming */
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #8b5cf6;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --success: #10b981;
      
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius: 0.5rem;
      --radius-sm: 0.25rem;
      --radius-lg: 0.75rem;
    }

    /* Dark theme */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border: #334155;
      --border-light: #475569;
    }

    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* App layout */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 100;
      position: relative;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      max-width: 100%;
    }

    .app-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Tabs */
    .tabs-container {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .tabs-container::-webkit-scrollbar {
      display: none;
    }

    .tabs {
      display: flex;
      min-width: max-content;
      padding: 0 1rem;
      align-items: center;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      white-space: nowrap;
      min-width: 120px;
      position: relative;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: var(--bg-tertiary);
    }

    .tab:hover:not(.active) {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .tab-close {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .tab-close:hover {
      background: var(--border);
    }

    /* New tab button */
    .new-tab-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      transition: all 0.2s ease;
      margin-left: 0.5rem;
      flex-shrink: 0;
    }

    .new-tab-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Toolbar */
    .toolbar {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 1rem;
      display: flex;
      gap: 0.25rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .toolbar::-webkit-scrollbar {
      display: none;
    }

    .toolbar-group {
      display: flex;
      gap: 0.25rem;
      padding-right: 0.5rem;
      border-right: 1px solid var(--border);
      align-items: center;
    }

    .toolbar-group:last-child {
      border-right: none;
    }

    .toolbar-button {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.75rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      white-space: nowrap;
      position: relative;
    }

    .toolbar-button:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border);
    }

    .toolbar-button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Dropdown menus */
    .dropdown {
      position: relative;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      min-width: 200px;
      z-index: 1000;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-primary);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      transition: background 0.2s ease;
    }

    .dropdown-item:hover {
      background: var(--bg-tertiary);
    }

    .dropdown-item:first-child {
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 var(--radius) var(--radius);
    }

    /* Editor container */
    .editor-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .editor-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
      overflow: hidden;
    }

    .editor-content {
      flex: 1;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #editor {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      outline: none;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
      background: transparent;
    }

    /* Tables */
    table {
      border-collapse: collapse;
      margin: 1rem 0;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    td, th {
      border: 1px solid var(--border);
      padding: 0.75rem;
      text-align: left;
      background: var(--bg-primary);
    }

    th {
      background: var(--bg-tertiary);
      font-weight: 600;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .header-content {
        padding: 0.5rem 1rem;
      }
      
      .app-title {
        font-size: 1rem;
      }

      .tabs {
        padding: 0 0.5rem;
      }

      .tab {
        min-width: 80px;
        padding: 0.625rem 0.5rem;
        font-size: 0.8125rem;
      }

      .new-tab-btn {
        width: 28px;
        height: 28px;
        font-size: 1rem;
        margin-left: 0.25rem;
      }

      .toolbar {
        padding: 0.25rem 0.5rem;
        gap: 0.125rem;
      }

      .toolbar-group {
        padding-right: 0.25rem;
        gap: 0.125rem;
      }

      .toolbar-button {
        padding: 0.375rem 0.5rem;
        font-size: 0.75rem;
        min-width: 36px;
        min-height: 36px;
      }

      .toolbar-button .icon {
        font-size: 1rem;
      }

      .toolbar-button span:not(.icon) {
        display: none;
      }

      .editor-wrapper {
        padding: 0.5rem;
      }

      #editor {
        padding: 1rem;
        font-size: 0.9375rem;
      }

      .dropdown-menu {
        position: fixed;
        left: 0.5rem;
        right: 0.5rem;
        width: auto;
        max-height: 60vh;
        overflow-y: auto;
        z-index: 10000;
      }
    }

    /* Touch-friendly improvements */
    @media (pointer: coarse) {
      .toolbar-button {
        min-height: 44px;
        min-width: 44px;
      }

      .tab {
        min-height: 44px;
      }

      .dropdown-item {
        min-height: 44px;
        padding: 0.875rem 1rem;
      }

      .new-tab-btn {
        min-width: 44px;
        min-height: 44px;
      }
    }

    /* Status bar */
    .status-bar {
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Loading and save indicators */
    .save-indicator {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .save-indicator.saving {
      color: var(--warning);
    }

    .save-indicator.saved {
      color: var(--success);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    .dropdown-menu.show {
      animation: fadeIn 0.2s ease;
    }

    /* Icons (using Unicode symbols for now) */
    .icon {
      font-style: normal;
      font-variant: normal;
      text-rendering: auto;
      line-height: 1;
    }

    /* Responsive improvements */
    @media (max-width: 480px) {
      .toolbar-group {
        flex-wrap: nowrap;
      }
      
      .editor-wrapper {
        padding: 0.25rem;
      }
      
      .editor-content {
        border-radius: var(--radius-sm);
      }

      .header-content {
        padding: 0.375rem 0.75rem;
      }

      .app-title {
        font-size: 0.9375rem;
      }

      .header-actions {
        gap: 0.25rem;
      }

      .header-actions .toolbar-button {
        padding: 0.25rem;
        min-width: 32px;
        min-height: 32px;
      }
    }

    /* Print styles */
    @media print {
      .header, .tabs-container, .toolbar, .status-bar {
        display: none;
      }
      
      .editor-container {
        overflow: visible;
      }
      
      .editor-wrapper {
        max-width: none;
        padding: 0;
      }
      
      .editor-content {
        box-shadow: none;
        border-radius: 0;
      }
      
      #editor {
        padding: 0;
      }
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
      max-width: 300px;
      word-wrap: break-word;
    }

    .notification.success {
      background: var(--success);
      color: white;
    }

    .notification.error {
      background: var(--danger);
      color: white;
    }

    .notification.info {
      background: var(--info);
      color: white;
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1 class="app-title">
          <span class="icon">📝</span>
          Текстовый редактор Pro
        </h1>
        <div class="header-actions">
          <button class="toolbar-button" onclick="toggleTheme()" title="Переключить тему">
            <span class="icon">🌙</span>
          </button>
          <button class="toolbar-button" onclick="showInfo()" title="Информация">
            <span class="icon">ℹ️</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tabs" id="tabs">
        <!-- Tabs will be rendered here -->
        <button class="new-tab-btn" onclick="newNote()" title="Новая вкладка">
          <span class="icon">+</span>
        </button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <!-- File operations -->
      <div class="toolbar-group">
        <div class="dropdown">
          <button class="toolbar-button" onclick="toggleDropdown('file-menu')">
            <span class="icon">📁</span>
            <span>Файл</span>
          </button>
          <div class="dropdown-menu" id="file-menu">
            <button class="dropdown-item" onclick="document.getElementById('fileInput').click(); closeAllDropdowns();">
              <span class="icon">📂</span>
              Открыть файл
            </button>
            <button class="dropdown-item" onclick="saveToLocalStorage(); closeAllDropdowns();">
              <span class="icon">💾</span>
              Сохранить
            </button>
            <button class="dropdown-item" onclick="saveAs('html'); closeAllDropdowns();">
              <span class="icon">🌐</span>
              Экспорт HTML
            </button>
            <button class="dropdown-item" onclick="saveAs('txt'); closeAllDropdowns();">
              <span class="icon">📝</span>
              Экспорт TXT
            </button>
          </div>
        </div>
      </div>

      <!-- Text formatting -->
      <div class="toolbar-group">
        <button class="toolbar-button" onclick="formatText('bold')" title="Жирный">
          <span class="icon">𝐁</span>
        </button>
        <button class="toolbar-button" onclick="formatText('italic')" title="Курсив">
          <span class="icon">𝐼</span>
        </button>
        <button class="toolbar-button" onclick="formatText('underline')" title="Подчёркнутый">
          <span class="icon">U̲</span>
        </button>
      </div>

      <!-- Lists and alignment -->
      <div class="toolbar-group">
        <button class="toolbar-button" onclick="formatText('insertUnorderedList')" title="Маркированный список">
          <span class="icon">•</span>
        </button>
        <button class="toolbar-button" onclick="formatText('insertOrderedList')" title="Нумерованный список">
          <span class="icon">1.</span>
        </button>
        <button class="toolbar-button" onclick="formatText('justifyLeft')" title="По левому краю">
          <span class="icon">⬅️</span>
        </button>
        <button class="toolbar-button" onclick="formatText('justifyCenter')" title="По центру">
          <span class="icon">↔️</span>
        </button>
      </div>

      <!-- Insert -->
      <div class="toolbar-group">
        <div class="dropdown">
          <button class="toolbar-button" onclick="toggleDropdown('insert-menu')">
            <span class="icon">➕</span>
            <span>Вставить</span>
          </button>
          <div class="dropdown-menu" id="insert-menu">
            <button class="dropdown-item" onclick="insertTable(); closeAllDropdowns();">
              <span class="icon">📊</span>
              Таблица
            </button>
            <button class="dropdown-item" onclick="insertLink(); closeAllDropdowns();">
              <span class="icon">🔗</span>
              Ссылка
            </button>
            <button class="dropdown-item" onclick="document.getElementById('imageInput').click(); closeAllDropdowns();">
              <span class="icon">🖼️</span>
              Изображение
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor -->
    <div class="editor-container">
      <div class="editor-wrapper">
        <div class="editor-content">
          <div id="editor" contenteditable="true" placeholder="Начните писать..."></div>
        </div>
      </div>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
      <div class="save-indicator" id="saveIndicator">
        <span class="icon">💾</span>
        <span id="saveStatus">Сохранено</span>
      </div>
      <div id="wordCount">Слов: 0</div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="fileInput" style="display: none" accept=".txt,.html,.doc,.docx,.pdf" />
    <input type="file" id="imageInput" style="display: none" accept="image/*" />
  </div>

  <script>
    // Application state
    let notes = JSON.parse(localStorage.getItem('notes')) || [];
    let currentNoteId = null;
    let saveTimeout = null;
    let isDarkTheme = localStorage.getItem('theme') === 'dark';

    // Initialize app
    function initApp() {
      // Apply theme
      if (isDarkTheme) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }

      // Initialize tabs
      if (notes.length === 0) {
        newNote();
      } else {
        currentNoteId = notes[0].id;
        document.getElementById('editor').innerHTML = notes[0].content;
      }
      renderTabs();
      updateWordCount();

      // Auto-save setup
      setInterval(autoSave, 3000);
      
      // Add event listeners
      setupEventListeners();
    }

    // Event listeners
    function setupEventListeners() {
      const editor = document.getElementById('editor');
      
      editor.addEventListener('input', () => {
        setSaveStatus('saving');
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          autoSave();
          setSaveStatus('saved');
        }, 1000);
        updateWordCount();
      });

      editor.addEventListener('paste', handlePaste);
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          closeAllDropdowns();
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    // Tab management
    function newNote() {
      const noteId = Date.now().toString();
      const noteNumber = notes.length + 1;
      notes.push({
        id: noteId,
        content: '',
        title: `Документ ${noteNumber}`,
        created: new Date().toISOString(),
        modified: new Date().toISOString()
      });
      currentNoteId = noteId;
      document.getElementById('editor').innerHTML = '';
      saveNotes();
      renderTabs();
      updateWordCount();
    }

    function switchNote(noteId) {
      autoSave(); // Save current note before switching
      currentNoteId = noteId;
      const note = notes.find(n => n.id === noteId);
      document.getElementById('editor').innerHTML = note.content;
      renderTabs();
      updateWordCount();
    }

    function deleteTab(noteId, event) {
      event.stopPropagation();
      if (notes.length <= 1) {
        showNotification('Должна остаться хотя бы одна вкладка', 'error');
        return;
      }

      if (confirm('Удалить вкладку?')) {
        const index = notes.findIndex(n => n.id === noteId);
        notes.splice(index, 1);
        
        if (noteId === currentNoteId) {
          currentNoteId = notes[Math.max(index - 1, 0)].id;
          document.getElementById('editor').innerHTML = notes.find(n => n.id === currentNoteId).content;
        }
        
        saveNotes();
        renderTabs();
        updateWordCount();
      }
    }

    function renameTab(noteId) {
      const note = notes.find(n => n.id === noteId);
      const newTitle = prompt('Новое название:', note.title);
      if (newTitle && newTitle.trim()) {
        note.title = newTitle.trim();
        note.modified = new Date().toISOString();
        saveNotes();
        renderTabs();
      }
    }

    function renderTabs() {
      const tabsContainer = document.getElementById('tabs');
      const newTabBtn = tabsContainer.querySelector('.new-tab-btn');
      
      // Clear existing tabs but keep the new tab button
      tabsContainer.innerHTML = '';
      
      // Add tabs
      notes.forEach(note => {
        const tabElement = document.createElement('div');
        tabElement.className = `tab ${note.id === currentNoteId ? 'active' : ''}`;
        tabElement.onclick = () => switchNote(note.id);
        tabElement.ondblclick = () => renameTab(note.id);
        tabElement.innerHTML = `
          <span>${note.title}</span>
          <div class="tab-close" onclick="deleteTab('${note.id}', event)">
            <span class="icon">×</span>
          </div>
        `;
        tabsContainer.appendChild(tabElement);
      });
      
      // Re-add the new tab button
      tabsContainer.appendChild(newTabBtn);
    }

    // Editor functions
    function formatText(command, value) {
      document.execCommand(command, false, value);
      autoSave();
      updateWordCount();
    }

    function insertTable() {
      const rows = prompt('Количество строк:', '3');
      const cols = prompt('Количество столбцов:', '3');
      
      if (rows && cols && rows > 0 && cols > 0) {
        let tableHTML = '<table>';
        
        // Header row
        tableHTML += '<tr>';
        for (let j = 0; j < cols; j++) {
          tableHTML += `<th contenteditable>Заголовок ${j + 1}</th>`;
        }
        tableHTML += '</tr>';
        
        // Data rows
        for (let i = 1; i < rows; i++) {
          tableHTML += '<tr>';
          for (let j = 0; j < cols; j++) {
            tableHTML += `<td contenteditable>Ячейка ${i + 1}-${j + 1}</td>`;
          }
          tableHTML += '</tr>';
        }
        
        tableHTML += '</table>';
        document.execCommand('insertHTML', false, tableHTML);
        autoSave();
      }
    }

    function insertLink() {
      const url = prompt('Введите URL:');
      const text = prompt('Текст ссылки:', url);
      
      if (url) {
        const linkHTML = `<a href="${url}" target="_blank">${text || url}</a>`;
        document.execCommand('insertHTML', false, linkHTML);
        autoSave();
      }
    }

    // File operations
    function saveToLocalStorage() {
      autoSave();
      setSaveStatus('saved');
      showNotification('Документ сохранён', 'success');
    }

    function saveAs(format) {
      const editor = document.getElementById('editor');
      const content = format === 'html' ? editor.innerHTML : editor.innerText;
      const mimeType = format === 'html' ? 'text/html' : 'text/plain';
      
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `document.${format}`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification(`Файл экспортирован как ${format.toUpperCase()}`, 'success');
    }

    // Auto-save and storage
    function autoSave() {
      const note = notes.find(n => n.id === currentNoteId);
      if (note) {
        note.content = document.getElementById('editor').innerHTML;
        note.modified = new Date().toISOString();
        saveNotes();
      }
    }

    function saveNotes() {
      localStorage.setItem('notes', JSON.stringify(notes));
    }

    // UI helpers
    function toggleDropdown(menuId) {
      closeAllDropdowns();
      const menu = document.getElementById(menuId);
      menu.classList.toggle('show');
      
      // Position dropdown for mobile
      if (window.innerWidth <= 768) {
        const rect = menu.previousElementSibling.getBoundingClientRect();
        menu.style.top = (rect.bottom + window.scrollY) + 'px';
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
      });
    }

    function setSaveStatus(status) {
      const indicator = document.getElementById('saveIndicator');
      const statusText = document.getElementById('saveStatus');
      
      indicator.className = `save-indicator ${status}`;
      statusText.textContent = status === 'saving' ? 'Сохранение...' : 'Сохранено';
    }

    function updateWordCount() {
      const editor = document.getElementById('editor');
      const text = editor.innerText || '';
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      document.getElementById('wordCount').textContent = `Слов: ${words}`;
    }

    // Theme management
    function toggleTheme() {
      isDarkTheme = !isDarkTheme;
      localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
      
      if (isDarkTheme) {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
      }
      
      showNotification(`Переключено на ${isDarkTheme ? 'тёмную' : 'светлую'} тему`, 'info');
    }

    // Notifications
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // File handling
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        newNote();
        const note = notes.find(n => n.id === currentNoteId);
        note.title = file.name.replace(/\.[^/.]+$/, "");
        
        if (file.type.includes('html')) {
          document.getElementById('editor').innerHTML = e.target.result;
        } else {
          document.getElementById('editor').innerText = e.target.result;
        }
        
        autoSave();
        renderTabs();
        updateWordCount();
        showNotification('Файл загружен', 'success');
      };
      reader.readAsText(file);
    });

    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.borderRadius = 'var(--radius)';
        
        document.execCommand('insertHTML', false, img.outerHTML);
        autoSave();
        showNotification('Изображение добавлено', 'success');
      };
      reader.readAsDataURL(file);
    });

    // Keyboard shortcuts
    function handleKeyboardShortcuts(e) {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 's':
            e.preventDefault();
            saveToLocalStorage();
            break;
          case 'n':
            e.preventDefault();
            newNote();
            break;
          case 'b':
            e.preventDefault();
            formatText('bold');
            break;
          case 'i':
            e.preventDefault();
            formatText('italic');
            break;
          case 'u':
            e.preventDefault();
            formatText('underline');
            break;
        }
      }
    }

    // Paste handling
    function handlePaste(e) {
      // Allow default paste behavior but trigger auto-save
      setTimeout(() => {
        autoSave();
        updateWordCount();
      }, 100);
    }

    // Info dialog
    function showInfo() {
      showNotification(`Текстовый редактор Pro v2.1\n\nВозможности:\n• Множественные вкладки\n• Форматирование текста\n• Таблицы и ссылки\n• Автосохранение\n• Тёмная тема\n• Экспорт в HTML/TXT\n• Горячие клавиши\n\nГорячие клавиши:\nCtrl+S - Сохранить\nCtrl+N - Новая вкладка\nCtrl+B - Жирный текст\nCtrl+I - Курсив\nCtrl+U - Подчёркивание`, 'info');
    }

    // Initialize app when page loads
    window.addEventListener('load', initApp);

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>
</body>
</html>

